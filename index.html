<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Zonas - GoSpin Logística</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .app {
      background: #ffffff;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      max-width: 520px;
      width: 100%;
    }
    .logo {
      font-weight: 800;
      font-size: 24px;
      margin-bottom: 4px;
      color: #ff9800;
    }
    .logo span {
      color: #333;
      font-weight: 600;
      font-size: 18px;
      margin-left: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }
    .mode-row {
      display: flex;
      gap: 16px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .mode-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .mode-option input {
      cursor: pointer;
    }
    label.main-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input[type="text"]:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 2px rgba(255,152,0,0.2);
    }
    button {
      margin-top: 12px;
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: #ff9800;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s;
    }
    button:hover {
      background: #fb8c00;
    }
    button:active {
      transform: scale(0.98);
    }
    .resultado {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #fafafa;
      border: 1px solid #eee;
      font-size: 14px;
      min-height: 40px;
    }
    .resultado.ok strong {
      color: #2e7d32;
    }
    .resultado.error {
      border-color: #ffcdd2;
      background: #ffebee;
      color: #c62828;
    }
    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #888;
    }
    .footer {
      margin-top: 16px;
      font-size: 11px;
      color: #aaa;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="logo">GoSpin<span>Logística</span></div>
    <div class="subtitle">Calculadora rápida de zona por localidad/barrio o por código postal.</div>

    <div class="mode-row">
      <span style="font-size:12px; color:#555;">Modo de búsqueda:</span>
      <label class="mode-option">
        <input type="radio" name="modo" value="localidad" id="modoLocalidad" checked />
        <span>Por localidad / barrio</span>
      </label>
      <label class="mode-option">
        <input type="radio" name="modo" value="cp" id="modoCP" />
        <span>Por código postal</span>
      </label>
    </div>

    <label for="busqueda" class="main-label">Texto a buscar</label>
    <input id="busqueda" type="text" placeholder="Ej: Caballito, Lanús, La Plata, 1704..." />
    <button id="btnBuscar">Ver zona</button>

    <div id="resultado" class="resultado"></div>
    <div class="hint">
      En modo localidad no hace falta escribir acentos. También funciona si escribís
      <strong>CABA</strong>, <strong>Capital</strong> o <strong>Capital Federal</strong>.
    </div>

    <div class="footer">Versión 1.4 · Soporte visual para búsqueda por localidad o código postal</div>
  </div>

  <script>
    let LOCALIDADES = [];
    let datosCargados = false;

    let CPS = [];
    let cpsCargados = false;

    let modoBusqueda = "localidad";

    function normalizar(texto) {
      return texto
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, " ")
        .trim();
    }

    function inicializarDatos() {
      return fetch("zonas.dat")
        .then(function(r) { return r.text(); })
        .then(function(b64) {
          const limpio = b64.trim();
          try {
            const jsonStr = atob(limpio);
            const arr = JSON.parse(jsonStr);
            LOCALIDADES = arr.map(function(item) {
              return { key: item[0], nombre: item[1], zona: item[2] };
            });
            datosCargados = true;
          } catch (e) {
            console.error("Error decodificando zonas.dat:", e);
            datosCargados = false;
          }
        })
        .catch(function(err) {
          console.error("Error cargando datos de zonas:", err);
          datosCargados = false;
        });
    }

    function inicializarCPs() {
      return Promise.resolve().then(function() {
        cpsCargados = false;
      });
    }

    function buscarZonaLocalidad(valor, resultadoEl) {
      const norm = normalizar(valor);

      if (!norm) {
        resultadoEl.className = "resultado error";
        resultadoEl.textContent = "Escribí una localidad o barrio para buscar.";
        return;
      }

      if (norm === "la matanza") {
        resultadoEl.className = "resultado error";
        resultadoEl.textContent = "El Partido de La Matanza tiene dos zonas tarifarias. Por favor ingresá el nombre de la localidad o buscá por código postal.";
        return;
      }

      const match = LOCALIDADES.find(function(item) { return item.key === norm; });

      if (!match) {
        resultadoEl.className = "resultado error";
        resultadoEl.textContent = "No encontré esa localidad/barrio en la tabla de GoSpin. Probá escribir solo el nombre (sin provincia ni país).";
        return;
      }

      resultadoEl.className = "resultado ok";
      resultadoEl.innerHTML = "Para <strong>" + match.nombre + "</strong> corresponde la <strong>" + match.zona + "</strong>.";
    }

    function buscarZonaCP(valor, resultadoEl) {
      const cp = valor.trim();

      if (!cp) {
        resultadoEl.className = "resultado error";
        resultadoEl.textContent = "Escribí un código postal para buscar.";
        return;
      }

      if (!cpsCargados || !CPS.length) {
        resultadoEl.className = "resultado error";
        resultadoEl.textContent = "La búsqueda por código postal va a estar disponible cuando carguemos la tabla de CPs. Por ahora, usá la búsqueda por localidad/barrio.";
        return;
      }

      resultadoEl.className = "resultado error";
      resultadoEl.textContent = "Función de búsqueda por código postal lista a nivel de código, falta cargar los datos reales de CPs.";
    }

    function buscarZona() {
      const input = document.getElementById("busqueda");
      const resultadoEl = document.getElementById("resultado");
      const valor = input.value || "";

      if (modoBusqueda === "localidad") {
        if (!datosCargados) {
          resultadoEl.className = "resultado error";
          resultadoEl.textContent = "Todavía se están cargando los datos de localidades. Esperá un segundo y probá de nuevo. Si el problema persiste, verificá que el archivo zonas.dat esté en la misma carpeta que index.html.";
          return;
        }
        buscarZonaLocalidad(valor, resultadoEl);
      } else {
        buscarZonaCP(valor, resultadoEl);
      }
    }

    document.getElementById("btnBuscar").addEventListener("click", buscarZona);
    document.getElementById("busqueda").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        buscarZona();
      }
    });

    document.getElementById("modoLocalidad").addEventListener("change", function() {
      if (this.checked) {
        modoBusqueda = "localidad";
      }
    });

    document.getElementById("modoCP").addEventListener("change", function() {
      if (this.checked) {
        modoBusqueda = "cp";
      }
    });

    inicializarDatos();
    inicializarCPs();
  </script>
</body>
</html>
